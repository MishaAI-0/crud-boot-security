<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Admin panel</title>
    <style>
        .nav-link.active {
            background-color: #0d6efd;
            color: aliceblue;
            border-radius: 5px;
        }
    </style>

</head>
<body>
<nav class="navbar bg-dark text-white ">
    <div class="container-fluid">
        <span class="navbar-text">
            <span class="login fw-bold" th:text="${currentUser.email}"></span>
            <span>with roles: </span>
            <span th:if="${not #lists.isEmpty(currentUser.roles.?[name == 'ROLE_ADMIN'])}" th:text="'ADMIN'"></span>
            <span th:each="role, iterStat : ${currentUser.roles}">
                <span
                   th:if="${role.name != 'ROLE_ADMIN'}"
                   th:text="${role.name == 'ROLE_USER' ? 'USER' : 'Other'}"></span>
                <span th:if="${!iterStat.last}"> </span>
            </span>
        </span>

        <div class="navbar-nav ms-auto">
            <a href="/logout" class="text-decoration-none fw-bold text-secondary">logout</a>
        </div>
    </div>

</nav>

<div class="wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-2 min-vh-100 ps-0 pe-0">
                <nav class="sidebar nav flex-column">
                    <a class="nav-link mt-4" th:if="${not #lists.isEmpty(currentUser.roles.?[name == 'ROLE_ADMIN'])}" th:text="'Admin'" th:href="'/admin'"
                       th:classappend="${#httpServletRequest.requestURI == '/admin'} ? 'active'"></a>
                    <a class="nav-link mt-4" th:each="role : ${currentUser.roles}"
                       th:if="${role.name != 'ROLE_ADMIN'}"
                       th:text="${role.name == 'ROLE_USER' ? 'User' : 'Other'}"
                       th:href="${role.name == 'ROLE_USER' ? '/user' : '/error'}"></a>
                </nav>
            </div>
            <div class="col-lg-10 bg-light">
                <div class="main-content">
                    <div class="title ms-4 mt-4">
                        <h1>Admin panel</h1>
                    </div>
                    <div class="list ms-4 mt-2" id="nav-home-tab">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#users">Users table</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#new-user">New User</a>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-content">
                        <div class="tab-pane fade show active ms-4 " id="users">
                            <h4 class="bg-light text-dark p-3 mb-0 border  border-1 rounded">All users
                            </h4>
                            <div class="wrapper-table p-3 border border-1 rounded bg-white">
                                <table class="table table-striped bg-white mb-0">

                                    <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">First Name</th>
                                        <th scope="col">Last Name</th>
                                        <th scope="col">Age</th>
                                        <th scope="col">Email</th>
                                        <th scope="col">Role</th>
                                        <th scope="col">Edit</th>
                                        <th scope="col">Delete</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="user : ${allUsers}">
                                        <td th:utext="${user.id}"></td>
                                        <td th:utext="${user.username}"></td>
                                        <td th:utext="${user.surname}"></td>
                                        <td th:utext="${user.age}"></td>
                                        <td th:utext="${user.email}"></td>
                                        <td>
                                            <ul style="list-style: none; padding: 0;">
                                                <li th:if="${not #lists.isEmpty(user.roles.?[name == 'ROLE_ADMIN'])}"
                                                    th:text="'ADMIN '" style="display: inline; margin-right: 5px;"></li>


                                                <li th:each="role : ${user.roles}" th:if="${role.name != 'ROLE_ADMIN'}"
                                                    th:text="${role.name == 'ROLE_USER' ? 'USER' : role.name}"
                                                    style="display: inline; margin-right: 5px;"></li>
                                            </ul>
                                        </td>
                                        <td>

                                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                                    data-bs-target="#editModal">Edit</button>
                                            <div class="modal fade" id="editModal" tabindex="-1">
                                                <div class=" modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="editModalTitle">Edit user</h5>
                                                            <button type="button" class="btn-close"
                                                                    data-bs-dismiss="modal"
                                                                    aria-label="Close"></button>
                                                        </div>
                                                        <form th:method="PATCH" id="edit-user-form"
                                                              th:action="@{/admin/update}" class="modal-body d-flex flex-column  justify-content-center
                                                                align-items-center" th:object="${user}">
                                                            <label for="editId" class="form-label fw-bold mb-0">ID
                                                            </label>
                                                            <input type="text" class="form-control w-50" id="editId"
                                                                    name="id" readonly/>


                                                            <label for="editFirstName"
                                                                   class="form-label fw-bold mb-0 mt-3">First Name
                                                            </label>
                                                            <input type="text" class="form-control w-50"
                                                                   id="editFirstName" name="username" >


                                                            <label for="editLastName"
                                                                   class="form-label fw-bold  mt-3 mb-0">Last
                                                                name</label>
                                                            <input type="text" class="form-control w-50"
                                                                   id="editLastName"  name="surname" >

                                                            <label for="editAge" class="form-label fw-bold  mt-3 mb-0">Age</label>
                                                            <input type="number" class="form-control w-50" id="editAge"
                                                                   name="age" >

                                                            <label for="editEmail"
                                                                   class="form-label fw-bold  mt-3 mb-0">Email</label>
                                                            <input type="email" class="form-control w-50"
                                                                   id="editEmail" name="email" >

                                                            <label for="editPassword"
                                                                   class="form-label fw-bold  mt-3 mb-0">Password</label>
                                                            <input type="password" class="form-control w-50"
                                                                   id="editPassword" name="password">

                                                            <label for="editRole"
                                                                   class="form-label fw-bold  mt-3 mb-0">Role</label>
                                                            <select class="form-select w-50 " id="editRole" size="2"
                                                                    aria-label="size 2 select example"
                                                                    name="updatedRole">
                                                                <option th:each="role: ${allRoles}" th:text="${role.name == 'ROLE_USER' ? 'USER' : 'ADMIN'}"></option>
                                                            </select>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary"
                                                                        data-bs-dismiss="modal">Close
                                                                </button>
                                                                <button type="submit" class="btn btn-primary">Edit
                                                                </button>
                                                            </div>
                                                        </form>

                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                                    th:attr="data-bs-target='#deleteModal'+ ${user.id}">Delete
                                            </button>

                                            <div class="modal fade" th:id="'deleteModal'+ ${user.id}" tabindex="-1">
                                                <div class=" modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="exampleModalLabel">Delete
                                                                user</h5>
                                                            <button type="button" class="btn-close"
                                                                    data-bs-dismiss="modal"
                                                                    aria-label="Close"></button>
                                                        </div>
                                                        <form th:object="${user}" th:method="DELETE"
                                                              th:action="@{/admin/delete}" class="modal-body d-flex flex-column  justify-content-center
                                                            align-items-center">

                                                            <label for="inputId" class="form-label fw-bold mb-0">ID
                                                            </label>
                                                            <input type="text" class="form-control w-50"
                                                                   id="inputId" th:value="${user.id}" name="deleteUserId" readonly>

                                                            <label for="inputFirstName"
                                                                   class="form-label fw-bold mb-0 mt-3">First
                                                            </label>
                                                            <input type="text" class="form-control w-50"
                                                                   id="inputFirstName" th:value="${user.username}" readonly>

                                                            <label for="inputLastName"
                                                                   class="form-label fw-bold  mt-3 mb-0">Last
                                                                name</label>
                                                            <input type="text" class="form-control w-50"
                                                                   id="inputLastName" th:value="${user.surname}" readonly>

                                                            <label for="inputAge" class="form-label fw-bold  mt-3 mb-0">Age</label>
                                                            <input type="text" class="form-control w-50" id="inputAge" th:value="${user.age}" readonly>

                                                            <label for="inputEmail"
                                                                   class="form-label fw-bold  mt-3 mb-0">Email</label>
                                                            <input type="text" class="form-control w-50"
                                                                   id="inputEmail" th:value="${user.email}" readonly>


                                                            <label for="inputRole"
                                                                   class="form-label fw-bold  mt-3 mb-0">Password</label>
                                                            <select class="form-select w-50" id="inputRole" size="2"
                                                                    aria-label="size 2 select example" disabled>
                                                                <option th:each="role: ${allRoles}" th:text="${role.name == 'ROLE_USER' ? 'USER' : 'ADMIN'}"></option>
                                                            </select>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary"
                                                                        data-bs-dismiss="modal">Close
                                                                </button>
                                                                <button type="submit" class="btn btn-danger">Delete
                                                                </button>
                                                            </div>
                                                        </form>

                                                    </div>
                                                </div>
                                            </div>

                                        </td>

                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                        <div class="tab-pane fade" id="new-user">
                            <h4 class="bg-light text-dark p-3 mb-0 border  border-1 rounded">Add new user
                            </h4>

                            <form th:method="POST" th:action="@{/admin/new}" th:object="${newUser}" class="wrapper-table p-3 border border-1 rounded bg-white d-flex flex-column  justify-content-center
                                align-items-center">
                                <label for="inputFirstName" class="form-label fw-bold mb-0">First name</label>
                                <input type="text" class="form-control w-25" id="inputFirstName"
                                       placeholder="First name" th:name="*{username}" th:field="*{username}">

                                <label for="inputLastName" class="form-label fw-bold  mt-3 mb-0">Last name</label>
                                <input type="text" class="form-control w-25" id="inputLastName"
                                       placeholder="Last name" th:name="*{surname}" th:field="*{surname}">

                                <label for="inputAge" class="form-label fw-bold  mt-3 mb-0">Age</label>
                                <input type="text" class="form-control w-25" id="inputAge" placeholder="Age"
                                       th:name="*{age}" th:field="*{age}">

                                <label for="inputEmail" class="form-label fw-bold  mt-3 mb-0">Email</label>
                                <input type="text" class="form-control w-25" id="inputEmail" placeholder="Email"
                                       th:name="*{email}" th:field="*{email}">

                                <label for="inputPassword" class="form-label fw-bold  mt-3 mb-0">Password</label>
                                <input type="password" class="form-control w-25" id="inputPassword"
                                       placeholder="Password" th:name="*{password}" th:field="*{password}">


                                <label for="inputRole" class="form-label fw-bold  mt-3 mb-0">Role</label>
                                <select class="form-select w-25 " id="inputRole" size="2"
                                        aria-label="size 2 select example"
                                        name="selectedRole">
                                    <option th:each="role : ${allRoles}" th:text="${role.name == 'ROLE_USER' ? 'USER' : 'ADMIN'}"></option>
                                </select>

                                <button type="submit" class="btn btn-success mt-3">Add new user</button>
                            </form>
                        </div>
                    </div>


                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
<script>
    const editModal = document.getElementById('editModal');
    editModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const parent = button.parentElement.parentElement;

        const rows = parent.querySelectorAll("td");
        let id, firstName, lastName, age, email;
        id = rows[0];
        firstName = rows[1];
        lastName = rows[2];
        age = rows[3];
        email = rows[4];


        const modalUserId = editModal.querySelector('#editId');
        const modalUserFirstName = editModal.querySelector('#editFirstName');
        const modalUserLastName = editModal.querySelector('#editLastName');
        const modalUserEmail = editModal.querySelector('#editEmail');
        const modalUserAge = editModal.querySelector('#editAge');

        modalUserId.value = id.innerText;
        modalUserFirstName.value = firstName.innerText;
        modalUserLastName.value = lastName.innerText;
        modalUserEmail.value = email.innerText;
        modalUserAge.value = age.innerText;


    })
</script>
</body>

</html>